<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Room Controller - Admin</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      padding: 20px;
      min-height: 100vh;
    }

    h1 {
      color: #00d4ff;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h2 {
      color: #888;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 30px 0 15px;
      border-bottom: 1px solid #333;
      padding-bottom: 5px;
    }

    .status-badge {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      background: #2a5;
      color: white;
    }

    .status-badge.offline {
      background: #a52;
    }

    .card {
      background: #252540;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-weight: 600;
      color: #fff;
    }

    .card-subtitle {
      font-size: 12px;
      color: #888;
      font-family: monospace;
    }

    .prop-status {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #555;
    }

    .dot.online { background: #2a5; }
    .dot.solved { background: #fa0; }

    .sensors-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }

    .sensor-tag {
      font-size: 11px;
      padding: 3px 8px;
      background: #333;
      border-radius: 4px;
      color: #aaa;
    }

    .sensor-tag.triggered {
      background: #2a5;
      color: white;
    }

    .actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: opacity 0.2s;
    }

    button:hover {
      opacity: 0.8;
    }

    .btn-primary {
      background: #00d4ff;
      color: #000;
    }

    .btn-secondary {
      background: #2563eb;
      color: #fff;
    }

    .btn-secondary:hover {
      background: #3b82f6;
    }

    .btn-danger {
      background: #a52;
      color: #fff;
    }

    .btn-small {
      padding: 4px 10px;
      font-size: 11px;
    }

    input, select {
      padding: 8px 12px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #1a1a2e;
      color: #fff;
      font-size: 14px;
      width: 100%;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #00d4ff;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
      color: #888;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 100;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #252540;
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal h3 {
      margin-bottom: 20px;
      color: #00d4ff;
    }

    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      padding: 12px 24px;
      border-radius: 8px;
      background: #2a5;
      color: white;
      opacity: 0;
      transition: all 0.3s;
      z-index: 200;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.error {
      background: #a52;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #333;
    }

    .info-label {
      color: #888;
    }

    .info-value {
      font-family: monospace;
    }

    .restart-warning {
      background: #fa0;
      color: #000;
      padding: 12px 20px;
      border-radius: 0;
      display: none;
      align-items: center;
      gap: 12px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      font-weight: 500;
    }

    .restart-warning.show {
      display: flex;
    }

    .restart-warning .btn-primary {
      background: #222;
      color: #fa0;
      border: none;
    }

    .restart-warning .btn-secondary {
      background: transparent;
      color: #222;
      border: 1px solid #222;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .sensor-editor {
      background: #1a1a2e;
      border-radius: 6px;
      padding: 12px;
      margin-top: 8px;
    }

    .sensor-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 8px;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #333;
    }

    .sensor-row:last-child {
      border-bottom: none;
    }

    .sensor-row input {
      padding: 6px 10px;
      font-size: 13px;
    }

    .sensor-row .btn-icon {
      width: 32px;
      height: 32px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      border-radius: 4px;
    }

    .sensor-header {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 8px;
      font-size: 11px;
      color: #666;
      padding-bottom: 6px;
      border-bottom: 1px solid #444;
      margin-bottom: 4px;
    }

    .prop-type-badge {
      font-size: 11px;
      padding: 3px 8px;
      background: #00d4ff33;
      color: #00d4ff;
      border-radius: 4px;
      margin-left: 8px;
    }

    .add-sensor-btn {
      width: 100%;
      margin-top: 10px;
      padding: 8px;
      background: #333;
      border: 1px dashed #555;
      color: #888;
      font-size: 12px;
    }

    .add-sensor-btn:hover {
      background: #3a3a5a;
      border-color: #00d4ff;
      color: #00d4ff;
    }

    .no-sensors {
      text-align: center;
      color: #666;
      font-size: 12px;
      padding: 15px;
    }

    .type-selector {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .type-selector select {
      flex: 1;
      max-width: 250px;
    }

    .type-selector .type-actions {
      display: flex;
      gap: 4px;
    }

    .empty-types {
      color: #666;
      font-size: 13px;
      padding: 10px 0;
    }

    /* Step Groups for Props */
    .step-group {
      background: #1e1e35;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 8px;
      border: 2px solid transparent;
      transition: border-color 0.2s, background 0.2s;
      position: relative;
    }

    .step-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .step-header .step-number {
      background: #00d4ff33;
      color: #00d4ff;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
    }

    .step-props {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .step-props .card {
      flex: 1;
      min-width: 280px;
      margin-bottom: 0;
      cursor: grab;
      transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
    }

    .step-props .card:active {
      cursor: grabbing;
    }

    .step-props .card.dragging {
      opacity: 0.5;
      transform: scale(0.98);
    }

    .step-props .card .drag-handle {
      color: #555;
      margin-right: 8px;
      cursor: grab;
    }

    /* Drop Zones */
    .drop-zone {
      height: 4px;
      margin: 4px 0;
      border-radius: 2px;
      background: transparent;
      transition: all 0.2s;
    }

    .drop-zone.drag-over {
      height: 40px;
      background: #00d4ff33;
      border: 2px dashed #00d4ff;
      margin: 8px 0;
    }

    .drop-zone.drag-over::after {
      content: 'Nouvelle Ã©tape';
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #00d4ff;
      font-size: 12px;
    }

    /* Parallel drop indicator */
    .parallel-indicator {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fa0;
      color: #000;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      pointer-events: none;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      white-space: nowrap;
    }

    .step-group.drag-over-parallel .parallel-indicator {
      display: block;
    }

    /* New step indicator (when hovering top/bottom of step) */
    .new-step-indicator {
      display: none;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      background: #00d4ff;
      color: #000;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      pointer-events: none;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      white-space: nowrap;
    }

    .step-group.drag-over-newstep-after {
      border-bottom: 3px solid #00d4ff;
    }

    .step-group.drag-over-newstep-before {
      border-top: 3px solid #00d4ff;
    }

    .step-group.drag-over-newstep-after .new-step-indicator,
    .step-group.drag-over-newstep-before .new-step-indicator {
      display: block;
    }

    .step-group.drag-over-newstep-after .new-step-indicator {
      bottom: -16px;
      top: auto;
    }

    .step-group.drag-over-newstep-before .new-step-indicator {
      top: -16px;
      bottom: auto;
    }

    .step-group.drag-over-newstep-after .parallel-indicator,
    .step-group.drag-over-newstep-before .parallel-indicator {
      display: none;
    }

    /* Highlight the step group when dragging over */
    .step-group.drag-over-parallel {
      background: #2a2a45;
      border-color: #fa0;
    }

    /* Hide separate drop zones - we use card zones instead */
    .drop-zone {
      display: none;
    }

    .step-props .card {
      position: relative;
    }

    .parallel-badge {
      font-size: 11px;
      color: #fa0;
      background: #fa01a;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .drag-handle {
      color: #555;
      margin-right: 8px;
      cursor: grab;
      user-select: none;
    }

    .card[draggable="true"]:hover .drag-handle {
      color: #00d4ff;
    }

    /* Tabs */
    .tab-bar {
      display: flex;
      gap: 4px;
      border-bottom: 2px solid #333;
      margin-bottom: 20px;
      position: sticky;
      top: 0;
      background: #1a1a2e;
      z-index: 50;
      padding: 8px 0 0;
    }

    .tab {
      padding: 8px 20px;
      background: transparent;
      color: #888;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: -2px;
      transition: color 0.2s, border-color 0.2s;
    }

    .tab:hover {
      color: #ccc;
    }

    .tab.active {
      color: #00d4ff;
      border-bottom-color: #00d4ff;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Audio tab */
    .media-upload-area {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .media-upload-area .form-group {
      margin-bottom: 0;
    }

    .media-table {
      width: 100%;
      font-size: 13px;
      border-collapse: collapse;
    }

    .media-table th {
      text-align: left;
      padding: 8px;
      color: #888;
      border-bottom: 1px solid #333;
      font-size: 12px;
    }

    .media-table td {
      padding: 8px;
      border-bottom: 1px solid #2a2a2a;
      vertical-align: middle;
    }

    .media-table tr:hover {
      background: #2a2a45;
    }

    .media-preview-btn {
      width: 30px;
      height: 30px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #333;
      color: #00d4ff;
      border-radius: 50%;
      font-size: 14px;
    }

    .role-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      background: #a78bfa33;
      color: #a78bfa;
      margin-left: 6px;
    }
  </style>
</head>
<body>
  <h1>
    <span>Room Controller</span>
    <span class="status-badge" id="connectionStatus">Chargement...</span>
  </h1>

  <div class="restart-warning" id="restartWarning">
    <span>âš ï¸ Modifications non sauvegardees</span>
    <button class="btn-primary btn-small" onclick="reloadConfig()">Sauvegarder & Appliquer</button>
    <button class="btn-secondary btn-small" onclick="discardChanges()">Annuler</button>
  </div>

  <div class="tab-bar">
    <button class="tab active" data-tab="general">General</button>
    <button class="tab" data-tab="props">Props</button>
    <button class="tab" data-tab="automatismes">Automatismes</button>
    <button class="tab" data-tab="audio">Audio</button>
    <button class="tab" data-tab="stats">Statistiques</button>
  </div>

  <!-- â•â•â• TAB: General â•â•â• -->
  <div class="tab-panel active" id="tab-general">

  <!-- Room Info -->
  <h2>Salle</h2>
  <div class="card">
    <div class="info-row">
      <span class="info-label">ID</span>
      <span class="info-value" id="roomId">-</span>
    </div>
    <div class="info-row">
      <span class="info-label">Nom</span>
      <span class="info-value" id="roomName">-</span>
    </div>
    <div class="info-row">
      <span class="info-label">Site</span>
      <span class="info-value" id="roomSite">-</span>
    </div>
    <div class="actions">
      <button class="btn-secondary btn-small" onclick="openEditRoomModal()">Modifier</button>
    </div>
  </div>

  <!-- MQTT Settings -->
  <h2>MQTT</h2>
  <div class="card">
    <div class="info-row">
      <span class="info-label">Broker</span>
      <span class="info-value" id="mqttBroker">-</span>
    </div>
    <div class="info-row">
      <span class="info-label">Base Topic</span>
      <span class="info-value" id="mqttBaseTopic">-</span>
    </div>
    <div class="actions">
      <button class="btn-secondary btn-small" onclick="openEditMqttModal()">Modifier</button>
    </div>
  </div>

  <!-- PiÃ¨ces (physical rooms) -->
  <h2>PiÃ¨ces</h2>
  <div class="card">
    <p style="color: #aaa; font-size: 13px; margin-bottom: 12px;">
      Organisez vos props par piÃ¨ce physique (ex: Salle d'entrÃ©e, Laboratoire, Salle secrÃ¨te).
    </p>
    <div id="piecesList" style="margin-bottom: 12px;"></div>
    <div class="actions">
      <button class="btn-secondary btn-small" onclick="openAddPieceModal()">+ Ajouter une piÃ¨ce</button>
    </div>
  </div>

  <!-- Sensor Types -->
  <h2>Types de Capteurs</h2>
  <div class="card">
    <div class="type-selector">
      <select id="sensorTypesDropdown" onchange="onSensorTypeSelected()">
        <option value="">-- Selectionner pour modifier --</option>
      </select>
      <div class="type-actions">
        <button class="btn-secondary btn-small" onclick="editSelectedSensorType()" id="editTypeBtn" disabled>Modifier</button>
        <button class="btn-danger btn-small" onclick="deleteSelectedSensorType()" id="deleteTypeBtn" disabled>Supprimer</button>
      </div>
    </div>
    <div class="actions">
      <button class="btn-secondary btn-small" onclick="openAddSensorTypeModal()">+ Ajouter un type</button>
    </div>
  </div>

  <!-- Export / Import -->
  <h2>Export / Import</h2>
  <div class="card">
    <p style="color: #aaa; font-size: 13px; margin-bottom: 12px;">
      Exporter la configuration et les medias de cette salle pour les importer sur un autre Room Controller.
      Les parametres reseau (MQTT, ports) sont exclus de l'export.
    </p>
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
      <button class="btn-primary btn-small" onclick="exportRoom()">Exporter la salle</button>
      <label style="font-size: 13px; color: #aaa; display: flex; align-items: center; gap: 6px;">
        <input type="checkbox" id="exportHistory"> Inclure l'historique des sessions
      </label>
    </div>
    <hr style="border-color: #333; margin: 12px 0;">
    <p style="color: #fa0; font-size: 12px; margin-bottom: 8px;">
      L'import remplacera toute la configuration et les medias actuels.
    </p>
    <div style="display: flex; align-items: center; gap: 12px;">
      <input type="file" id="importFile" accept=".zip" style="width: auto; font-size: 12px;">
      <button class="btn-secondary btn-small" onclick="importRoom()" id="importBtn">Importer</button>
    </div>
    <div id="importProgress" style="display: none; margin-top: 10px; color: #00d4ff; font-size: 13px;">
      Import en cours...
    </div>
  </div>

  </div><!-- /tab-general -->

  <!-- â•â•â• TAB: Props â•â•â• -->
  <div class="tab-panel" id="tab-props">
  <h2>Props</h2>
  <button class="btn-primary" onclick="openAddPropModal()" style="margin-bottom: 15px;">+ Ajouter un Prop</button>
  <div id="propsList"></div>
  </div><!-- /tab-props -->

  <!-- â•â•â• TAB: Automatismes â•â•â• -->
  <div class="tab-panel" id="tab-automatismes">
  <h2>Automatismes</h2>
  <button class="btn-primary" onclick="openAddScenarioModal()" style="margin-bottom: 15px;">+ Ajouter un Automatisme</button>
  <div id="scenariosList"></div>
  </div><!-- /tab-automatismes -->

  <!-- â•â•â• TAB: Audio â•â•â• -->
  <div class="tab-panel" id="tab-audio">
  <h2>Audio</h2>
  <div class="card">
    <h3 style="font-size: 14px; color: #ccc; margin-bottom: 12px;">Importer un fichier audio</h3>
    <div class="media-upload-area">
      <div class="form-group">
        <label>Fichier</label>
        <input type="file" id="mediaFile" accept="audio/*" style="width: auto; font-size: 12px;">
      </div>
      <div class="form-group">
        <label>Nom</label>
        <input type="text" id="mediaName" placeholder="Nom du son" style="width: 200px;">
      </div>
      <div class="form-group">
        <label>Type</label>
        <select id="mediaType" style="width: 150px;">
          <option value="effect">Effet sonore</option>
          <option value="music">Musique</option>
        </select>
      </div>
      <button class="btn-primary btn-small" onclick="uploadMedia()">Importer</button>
    </div>
  </div>

  <h3 style="color: #888; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px;">Effets sonores</h3>
  <div class="card">
    <table class="media-table">
      <thead>
        <tr>
          <th></th>
          <th>Nom</th>
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="effectsList"></tbody>
    </table>
    <div id="effectsEmpty" class="empty-state" style="display:none;">Aucun effet sonore</div>
  </div>

  <h3 style="color: #888; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px;">Musiques</h3>
  <div class="card">
    <table class="media-table">
      <thead>
        <tr>
          <th></th>
          <th>Nom</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="musicList"></tbody>
    </table>
    <div id="musicEmpty" class="empty-state" style="display:none;">Aucune musique</div>
  </div>
  <audio id="mediaPreviewAudio" style="display:none;"></audio>
  </div><!-- /tab-audio -->

  <!-- â•â•â• TAB: Stats â•â•â• -->
  <div class="tab-panel" id="tab-stats">

  <!-- Statistiques -->
  <h2>Statistiques</h2>
  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
    <div class="card" style="text-align: center; padding: 15px;">
      <div style="font-size: 28px; font-weight: bold; color: #00d4ff;" id="statTotal">-</div>
      <div style="font-size: 12px; color: #888;">Sessions</div>
    </div>
    <div class="card" style="text-align: center; padding: 15px;">
      <div style="font-size: 28px; font-weight: bold; color: #22c55e;" id="statWinRate">-</div>
      <div style="font-size: 12px; color: #888;">Victoires</div>
    </div>
    <div class="card" style="text-align: center; padding: 15px;">
      <div style="font-size: 28px; font-weight: bold; color: #f59e0b;" id="statAvgTime">-</div>
      <div style="font-size: 12px; color: #888;">Temps moyen</div>
    </div>
    <div class="card" style="text-align: center; padding: 15px;">
      <div style="font-size: 28px; font-weight: bold; color: #a78bfa;" id="statAvgHints">-</div>
      <div style="font-size: 12px; color: #888;">Indices moy.</div>
    </div>
  </div>

  <div class="card" id="propStatsCard" style="display: none; margin-bottom: 15px;">
    <h3 style="margin-bottom: 10px; font-size: 14px; color: #ccc;">Analytique par Enigme</h3>
    <div style="overflow-x: auto;">
      <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 1px solid #333; color: #888;">
            <th style="text-align: left; padding: 6px 8px;">Prop</th>
            <th style="text-align: center; padding: 6px 8px;">Resolution</th>
            <th style="text-align: center; padding: 6px 8px;">Override</th>
            <th style="text-align: center; padding: 6px 8px;">Temps moy.</th>
            <th style="text-align: center; padding: 6px 8px;">Min</th>
            <th style="text-align: center; padding: 6px 8px;">Max</th>
            <th style="text-align: center; padding: 6px 8px;">Sessions</th>
          </tr>
        </thead>
        <tbody id="propStatsBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="sessionListCard" style="display: none;">
    <h3 style="margin-bottom: 10px; font-size: 14px; color: #ccc;">Historique des sessions</h3>
    <div id="sessionListAdmin" style="max-height: 400px; overflow-y: auto;"></div>
  </div>
  </div><!-- /tab-stats -->

  <!-- â•â•â•â•â•â•â•â• MODALS (outside tabs) â•â•â•â•â•â•â•â• -->

  <!-- Add/Edit Scenario Modal -->
  <div class="modal-overlay" id="scenarioModal">
    <div class="modal" style="max-width: 600px;">
      <h3 id="scenarioModalTitle">Ajouter un Automatisme</h3>
      <form id="scenarioForm">
        <input type="hidden" id="scenarioEditMode" value="add">
        <input type="hidden" id="scenarioId">
        <div class="form-group">
          <label>Nom</label>
          <input type="text" id="scenarioName" placeholder="Ex: Son apres coffre ouvert" required>
        </div>
        <div class="form-group">
          <label>Actif</label>
          <select id="scenarioEnabled">
            <option value="true">Oui</option>
            <option value="false">Non</option>
          </select>
        </div>

        <h4 style="color: #00d4ff; margin: 16px 0 8px; font-size: 13px;">DECLENCHEUR</h4>
        <div class="form-group">
          <label>Type</label>
          <select id="scenarioTriggerType" onchange="onTriggerTypeChange()">
            <option value="prop_solved">Enigme resolue</option>
            <option value="sensor_triggered">Capteur declenche</option>
            <option value="timer">Temps ecoule</option>
            <option value="session_start">Debut de session</option>
            <option value="session_end">Fin de session</option>
          </select>
        </div>
        <div class="form-group" id="triggerPropGroup">
          <label>Prop</label>
          <select id="scenarioTriggerPropId"></select>
        </div>
        <div class="form-group" id="triggerSensorGroup" style="display:none;">
          <label>Capteur</label>
          <select id="scenarioTriggerSensorId"></select>
        </div>
        <div class="form-group" id="triggerTimerGroup" style="display:none;">
          <label>Temps ecoule (minutes:secondes)</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="number" id="scenarioTriggerMinutes" min="0" max="180" value="0" style="width:80px;"> min
            <input type="number" id="scenarioTriggerSeconds" min="0" max="59" value="0" style="width:80px;"> sec
          </div>
        </div>

        <h4 style="color: #00d4ff; margin: 16px 0 8px; font-size: 13px;">ACTIONS</h4>
        <div id="scenarioActionsList"></div>
        <button type="button" class="add-sensor-btn" onclick="addScenarioAction()" style="margin-top:8px;">+ Ajouter une action</button>

        <div class="actions" style="margin-top: 16px;">
          <button type="submit" class="btn-primary">Enregistrer</button>
          <button type="button" class="btn-secondary" onclick="closeModal('scenarioModal')">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Room Modal -->
  <div class="modal-overlay" id="editRoomModal">
    <div class="modal">
      <h3>Modifier la Salle</h3>
      <form id="editRoomForm">
        <div class="form-group">
          <label>ID (identifiant unique)</label>
          <input type="text" id="editRoomId" required>
        </div>
        <div class="form-group">
          <label>Nom</label>
          <input type="text" id="editRoomName" required>
        </div>
        <div class="form-group">
          <label>Site</label>
          <input type="text" id="editRoomSite" value="default">
        </div>
        <div class="actions">
          <button type="submit" class="btn-primary">Enregistrer</button>
          <button type="button" class="btn-secondary" onclick="closeModal('editRoomModal')">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit MQTT Modal -->
  <div class="modal-overlay" id="editMqttModal">
    <div class="modal">
      <h3>Parametres MQTT</h3>
      <form id="editMqttForm">
        <div class="form-group">
          <label>Broker URL</label>
          <input type="text" id="editMqttBroker" placeholder="mqtt://localhost:1883" required>
        </div>
        <div class="form-group">
          <label>Base Topic</label>
          <input type="text" id="editMqttBaseTopic" placeholder="ey/default/magie" required>
        </div>
        <div class="actions">
          <button type="submit" class="btn-primary">Enregistrer</button>
          <button type="button" class="btn-secondary" onclick="closeModal('editMqttModal')">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Prop Modal -->
  <div class="modal-overlay" id="propModal">
    <div class="modal">
      <h3 id="propModalTitle">Ajouter un Prop</h3>
      <form id="propForm">
        <input type="hidden" id="propEditMode" value="add">
        <input type="hidden" id="propOriginalId">
        <div class="form-group">
          <label>Prop ID (unique)</label>
          <input type="text" id="propId" placeholder="magie_puzzle1" required>
        </div>
        <input type="hidden" id="propOrder" value="1">
        <div class="form-row">
          <div class="form-group">
            <label>Nom</label>
            <input type="text" id="propName" placeholder="Puzzle Magique" required>
          </div>
          <div class="form-group">
            <label>Type de capteur</label>
            <select id="propType">
              <option value="">-- Aucun --</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>PiÃ¨ce</label>
          <select id="propPieceId">
            <option value="">-- Sans piÃ¨ce --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Capteurs</label>
          <div class="sensor-editor">
            <div class="sensor-header">
              <span>ID Capteur</span>
              <span>Label</span>
              <span></span>
            </div>
            <div id="sensorsList"></div>
            <button type="button" class="add-sensor-btn" onclick="addSensorRow()">+ Ajouter un capteur</button>
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="btn-primary">Enregistrer</button>
          <button type="button" class="btn-secondary" onclick="closeModal('propModal')">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Sensor Type Modal -->
  <div class="modal-overlay" id="sensorTypeModal">
    <div class="modal" style="max-width: 400px;">
      <h3 id="sensorTypeModalTitle">Ajouter un Type</h3>
      <form id="sensorTypeForm">
        <input type="hidden" id="sensorTypeEditMode" value="add">
        <input type="hidden" id="sensorTypeOriginalId">
        <div class="form-group">
          <label>ID (unique, sans espaces)</label>
          <input type="text" id="sensorTypeId" placeholder="ex: rfid, magnet, laser" required pattern="[a-z0-9_-]+">
        </div>
        <div class="form-group">
          <label>Label (affichage)</label>
          <input type="text" id="sensorTypeLabel" placeholder="ex: RFID, Aimant, Laser" required>
        </div>
        <div class="actions">
          <button type="submit" class="btn-primary">Enregistrer</button>
          <button type="button" class="btn-secondary" onclick="closeModal('sensorTypeModal')">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit PiÃ¨ce Modal -->
  <div class="modal-overlay" id="pieceModal">
    <div class="modal" style="max-width: 400px;">
      <h3 id="pieceModalTitle">Ajouter une PiÃ¨ce</h3>
      <form id="pieceForm">
        <input type="hidden" id="pieceEditId" value="">
        <div class="form-group">
          <label>Nom de la piÃ¨ce</label>
          <input type="text" id="pieceName" placeholder="ex: Salle d'entrÃ©e, Laboratoire" required>
        </div>
        <div class="form-group">
          <label>Ordre (position dans la sÃ©quence)</label>
          <input type="number" id="pieceOrder" min="1" value="1" required>
        </div>
        <div class="actions">
          <button type="submit" class="btn-primary">Enregistrer</button>
          <button type="button" class="btn-secondary" onclick="closeModal('pieceModal')">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Confirm Delete Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal" style="max-width: 350px; text-align: center;">
      <h3 style="margin-bottom: 10px;">Confirmer la suppression</h3>
      <p id="confirmMessage" style="color: #aaa; margin-bottom: 20px;">Supprimer ce capteur ?</p>
      <div class="actions" style="justify-content: center;">
        <button type="button" class="btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteSensor()">Supprimer</button>
        <button type="button" class="btn-secondary" onclick="closeModal('confirmModal')">Annuler</button>
      </div>
    </div>
  </div>

  <script>
    let config = null;          // Original config from server
    let localConfig = null;     // Working copy with pending edits
    let state = null;
    let hasUnsavedChanges = false;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // API Calls
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function fetchConfig() {
      const res = await fetch('/api/config');
      config = await res.json();
      localConfig = JSON.parse(JSON.stringify(config)); // Deep copy
      hasUnsavedChanges = false;
      hideRestartWarning();
      renderConfig();
    }

    function markUnsavedChanges() {
      hasUnsavedChanges = true;
      showRestartWarning();
    }

    async function fetchState() {
      try {
        const res = await fetch('/api/state');
        state = await res.json();
        document.getElementById('connectionStatus').textContent = 'Connecte';
        document.getElementById('connectionStatus').classList.remove('offline');
        renderProps();
      } catch (err) {
        document.getElementById('connectionStatus').textContent = 'Deconnecte';
        document.getElementById('connectionStatus').classList.add('offline');
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Rendering
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderConfig() {
      // Room info (use localConfig for display)
      document.getElementById('roomId').textContent = localConfig.room.id;
      document.getElementById('roomName').textContent = localConfig.room.name;
      document.getElementById('roomSite').textContent = localConfig.room.site || 'default';

      // MQTT
      document.getElementById('mqttBroker').textContent = localConfig.mqtt.broker;
      document.getElementById('mqttBaseTopic').textContent = localConfig.mqtt.baseTopic;

      renderSensorTypes();
      renderPiecesList();
      renderProps();
      renderScenarios();
    }

    function renderSensorTypes() {
      const dropdown = document.getElementById('sensorTypesDropdown');
      const types = localConfig.sensorTypes || [];

      dropdown.innerHTML = '<option value="">-- Selectionner pour modifier --</option>' +
        types.map(t => `<option value="${t.id}">${t.label}</option>`).join('');

      // Reset buttons state
      document.getElementById('editTypeBtn').disabled = true;
      document.getElementById('deleteTypeBtn').disabled = true;

      // Also update the prop type dropdown
      updatePropTypeDropdown();
    }

    function updatePropTypeDropdown(selectedType = '') {
      const dropdown = document.getElementById('propType');
      const types = localConfig.sensorTypes || [];

      dropdown.innerHTML = '<option value="">-- Aucun --</option>' +
        types.map(t => `<option value="${t.id}" ${t.id === selectedType ? 'selected' : ''}>${t.label}</option>`).join('');
    }

    function updatePropPieceDropdown(selectedPieceId = '') {
      const dropdown = document.getElementById('propPieceId');
      const pieces = (localConfig.pieces || []).sort((a, b) => (a.order || 0) - (b.order || 0));

      dropdown.innerHTML = '<option value="">-- Sans piÃ¨ce --</option>' +
        pieces.map(p => `<option value="${p.id}" ${p.id === selectedPieceId ? 'selected' : ''}>${p.name}</option>`).join('');
    }

    function onSensorTypeSelected() {
      const dropdown = document.getElementById('sensorTypesDropdown');
      const hasSelection = dropdown.value !== '';
      document.getElementById('editTypeBtn').disabled = !hasSelection;
      document.getElementById('deleteTypeBtn').disabled = !hasSelection;
    }

    function editSelectedSensorType() {
      const typeId = document.getElementById('sensorTypesDropdown').value;
      if (typeId) {
        openEditSensorTypeModal(typeId);
      }
    }

    function deleteSelectedSensorType() {
      const typeId = document.getElementById('sensorTypesDropdown').value;
      if (typeId) {
        deleteSensorType(typeId);
      }
    }

    function renderProps() {
      const container = document.getElementById('propsList');

      if (!localConfig.props || localConfig.props.length === 0) {
        container.innerHTML = '<div class="empty-state">Aucun prop configure</div>';
        return;
      }

      // Group props by order (step)
      const stepGroups = {};
      localConfig.props.forEach(prop => {
        const order = prop.order || 1;
        if (!stepGroups[order]) {
          stepGroups[order] = [];
        }
        stepGroups[order].push(prop);
      });

      // Get sorted step numbers
      const stepNumbers = Object.keys(stepGroups).map(Number).sort((a, b) => a - b);

      let html = '';

      // Initial drop zone
      html += `<div class="drop-zone" data-target-step="0" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDropBetween(event, 0)"></div>`;

      stepNumbers.forEach((stepNum, stepIndex) => {
        const propsInStep = stepGroups[stepNum];
        const isParallel = propsInStep.length > 1;

        html += `
          <div class="step-group" data-step="${stepNum}" ondragover="handleStepDragOver(event)" ondragleave="handleStepDragLeave(event)" ondrop="handleDropOnStep(event, ${stepNum})">
            <div class="step-header">
              <span class="step-number">Etape ${stepIndex + 1}</span>
              ${isParallel ? '<span class="parallel-badge">' + propsInStep.length + ' props en parallele</span>' : ''}
            </div>
            <div class="step-props">
              ${propsInStep.map(prop => renderPropCard(prop)).join('')}
            </div>
            <div class="parallel-indicator">Ajouter en parallele</div>
            <div class="new-step-indicator">Nouvelle etape</div>
          </div>
        `;

        // Drop zone after each step group
        html += `<div class="drop-zone" data-target-step="${stepNum}" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDropBetween(event, ${stepNum})"></div>`;
      });

      container.innerHTML = html;
    }

    function getPieceName(pieceId) {
      if (!pieceId) return null;
      const piece = (localConfig.pieces || []).find(p => p.id === pieceId);
      return piece?.name || null;
    }

    function renderPropCard(prop) {
      // Find runtime state for this prop
      const runtimeProp = state?.props?.find(p => p.propId === prop.propId);
      const isOnline = runtimeProp?.online || false;
      const isSolved = runtimeProp?.solved || false;

      // Type is now at prop level
      const propTypeLabel = getTypeLabel(prop.type);
      const propTypeBadge = propTypeLabel ? `<span class="prop-type-badge">${propTypeLabel}</span>` : '';

      // Piece badge (distinct orange/amber color)
      const pieceName = getPieceName(prop.pieceId);
      const pieceBadge = pieceName ? `<span class="piece-badge" style="background: #5c3d1e; color: #fbbf24; font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">ğŸšª ${pieceName}</span>` : '';

      const sensorsHtml = prop.sensors.map(s => {
        const triggered = runtimeProp?.sensors?.find(rs => rs.sensorId === s.sensorId)?.triggered;
        return `<span class="sensor-tag ${triggered ? 'triggered' : ''}">${s.label}</span>`;
      }).join('');

      return `
        <div class="card" draggable="true" data-prop-id="${prop.propId}" data-prop-order="${prop.order}"
             ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)">
          <div class="card-header">
            <div>
              <span class="drag-handle">â‹®â‹®</span>
              <span class="card-title">${prop.name}${propTypeBadge}${pieceBadge}</span>
              <div class="card-subtitle">${prop.propId}</div>
            </div>
            <div class="prop-status">
              <div class="dot ${isOnline ? 'online' : ''}" title="${isOnline ? 'En ligne' : 'Hors ligne'}"></div>
              <div class="dot ${isSolved ? 'solved' : ''}" title="${isSolved ? 'Resolu' : 'Non resolu'}"></div>
            </div>
          </div>
          <div class="sensors-list">${sensorsHtml || '<span style="color:#666;font-size:12px;">Aucun capteur</span>'}</div>
          <div class="actions">
            <button class="btn-secondary btn-small" onclick="openEditPropModal('${prop.propId}')">Modifier</button>
            <button class="btn-danger btn-small" onclick="deleteProp('${prop.propId}')">Supprimer</button>
          </div>
        </div>
      `;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Modals
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function openEditRoomModal() {
      document.getElementById('editRoomId').value = localConfig.room.id;
      document.getElementById('editRoomName').value = localConfig.room.name;
      document.getElementById('editRoomSite').value = localConfig.room.site || 'default';
      openModal('editRoomModal');
    }

    function openEditMqttModal() {
      document.getElementById('editMqttBroker').value = localConfig.mqtt.broker;
      document.getElementById('editMqttBaseTopic').value = localConfig.mqtt.baseTopic;
      openModal('editMqttModal');
    }

    function openAddPropModal() {
      document.getElementById('propModalTitle').textContent = 'Ajouter un Prop';
      document.getElementById('propEditMode').value = 'add';
      document.getElementById('propOriginalId').value = '';
      document.getElementById('propId').value = '';
      document.getElementById('propId').disabled = false;
      document.getElementById('propName').value = '';

      // Auto-assign next order (max existing order + 1)
      const maxOrder = localConfig.props.length > 0
        ? Math.max(...localConfig.props.map(p => p.order || 1))
        : 0;
      document.getElementById('propOrder').value = maxOrder + 1;

      // Update prop type dropdown
      updatePropTypeDropdown('');

      // Update piece dropdown
      updatePropPieceDropdown('');

      // Initialize with one empty sensor
      renderSensorsList([{ sensorId: '', label: '' }]);
      openModal('propModal');
    }

    function openEditPropModal(propId) {
      const prop = localConfig.props.find(p => p.propId === propId);
      if (!prop) return;

      document.getElementById('propModalTitle').textContent = 'Modifier le Prop';
      document.getElementById('propEditMode').value = 'edit';
      document.getElementById('propOriginalId').value = propId;
      document.getElementById('propId').value = prop.propId;
      document.getElementById('propId').disabled = true;
      document.getElementById('propName').value = prop.name;
      document.getElementById('propOrder').value = prop.order; // Preserved but hidden, order changed via drag & drop

      // Update prop type dropdown with current value
      updatePropTypeDropdown(prop.type || '');

      // Update piece dropdown with current value
      updatePropPieceDropdown(prop.pieceId || '');

      // Populate sensors list (type is now at prop level)
      const sensors = prop.sensors.map(s => ({
        sensorId: s.sensorId,
        label: s.label || ''
      }));
      renderSensorsList(sensors.length > 0 ? sensors : [{ sensorId: '', label: '' }]);
      openModal('propModal');
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // PiÃ¨ces (Physical Rooms) Management
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderPiecesList() {
      const container = document.getElementById('piecesList');
      const pieces = localConfig.pieces || [];

      if (pieces.length === 0) {
        container.innerHTML = '<div style="color: #666; font-size: 13px;">Aucune piÃ¨ce dÃ©finie</div>';
        return;
      }

      // Sort by order
      const sorted = [...pieces].sort((a, b) => (a.order || 0) - (b.order || 0));

      container.innerHTML = sorted.map(piece => `
        <div class="piece-row" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #333;">
          <span style="color: #00d4ff; font-weight: bold; min-width: 24px;">${piece.order || '-'}</span>
          <span style="flex: 1;">${piece.name}</span>
          <button class="btn-secondary btn-small" onclick="openEditPieceModal('${piece.id}')">Modifier</button>
          <button class="btn-danger btn-small" onclick="deletePiece('${piece.id}')">Supprimer</button>
        </div>
      `).join('');
    }

    function openAddPieceModal() {
      document.getElementById('pieceModalTitle').textContent = 'Ajouter une PiÃ¨ce';
      document.getElementById('pieceEditId').value = '';
      document.getElementById('pieceName').value = '';
      document.getElementById('pieceOrder').value = (localConfig.pieces?.length || 0) + 1;
      openModal('pieceModal');
    }

    function openEditPieceModal(pieceId) {
      const piece = (localConfig.pieces || []).find(p => p.id === pieceId);
      if (!piece) return;

      document.getElementById('pieceModalTitle').textContent = 'Modifier la PiÃ¨ce';
      document.getElementById('pieceEditId').value = pieceId;
      document.getElementById('pieceName').value = piece.name;
      document.getElementById('pieceOrder').value = piece.order || 1;
      openModal('pieceModal');
    }

    document.getElementById('pieceForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const editId = document.getElementById('pieceEditId').value;
      const name = document.getElementById('pieceName').value.trim();
      const order = parseInt(document.getElementById('pieceOrder').value) || 1;

      // Validate piece name
      if (!name) {
        showToast('Le nom de la piÃ¨ce est requis', true);
        return;
      }

      if (!localConfig.pieces) {
        localConfig.pieces = [];
      }

      if (editId) {
        // Update existing
        const idx = localConfig.pieces.findIndex(p => p.id === editId);
        if (idx !== -1) {
          localConfig.pieces[idx] = { ...localConfig.pieces[idx], name, order };
          showToast('PiÃ¨ce modifiÃ©e (non sauvegardÃ©)');
        } else {
          showToast('PiÃ¨ce introuvable', true);
          return;
        }
      } else {
        // Create new with generated ID
        const newId = 'piece-' + Date.now();
        localConfig.pieces.push({ id: newId, name, order });
        showToast('PiÃ¨ce ajoutÃ©e (non sauvegardÃ©)');
      }

      closeModal('pieceModal');
      markUnsavedChanges();
      renderConfig();
    });

    function deletePiece(pieceId) {
      const piece = (localConfig.pieces || []).find(p => p.id === pieceId);
      if (!piece) return;

      if (!confirm(`Supprimer la piÃ¨ce "${piece.name}" ?\n\nLes props associÃ©s ne seront pas supprimÃ©s mais seront dÃ©sassociÃ©s.`)) {
        return;
      }

      // Remove the piece
      const idx = localConfig.pieces.findIndex(p => p.id === pieceId);
      if (idx !== -1) {
        localConfig.pieces.splice(idx, 1);
      }

      // Unlink props from this piece
      localConfig.props.forEach(prop => {
        if (prop.pieceId === pieceId) {
          prop.pieceId = null;
        }
      });

      showToast('PiÃ¨ce supprimÃ©e (non sauvegardÃ©)');
      markUnsavedChanges();
      renderConfig();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Sensor Type Modal
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function openAddSensorTypeModal() {
      document.getElementById('sensorTypeModalTitle').textContent = 'Ajouter un Type';
      document.getElementById('sensorTypeEditMode').value = 'add';
      document.getElementById('sensorTypeOriginalId').value = '';
      document.getElementById('sensorTypeId').value = '';
      document.getElementById('sensorTypeId').disabled = false;
      document.getElementById('sensorTypeLabel').value = '';
      openModal('sensorTypeModal');
    }

    function openEditSensorTypeModal(typeId) {
      const sensorType = (localConfig.sensorTypes || []).find(t => t.id === typeId);
      if (!sensorType) return;

      document.getElementById('sensorTypeModalTitle').textContent = 'Modifier le Type';
      document.getElementById('sensorTypeEditMode').value = 'edit';
      document.getElementById('sensorTypeOriginalId').value = typeId;
      document.getElementById('sensorTypeId').value = sensorType.id;
      document.getElementById('sensorTypeId').disabled = true;
      document.getElementById('sensorTypeLabel').value = sensorType.label;
      openModal('sensorTypeModal');
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Sensor Editor
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderSensorsList(sensors) {
      const container = document.getElementById('sensorsList');

      if (!sensors || sensors.length === 0) {
        container.innerHTML = '<div class="no-sensors">Aucun capteur</div>';
        return;
      }

      container.innerHTML = sensors.map((sensor, index) => `
        <div class="sensor-row" data-index="${index}">
          <input type="text"
                 class="sensor-id"
                 value="${sensor.sensorId || ''}"
                 placeholder="ex: sensor1, magnet1">
          <input type="text"
                 class="sensor-label"
                 value="${sensor.label || ''}"
                 placeholder="Description du capteur">
          <button type="button" class="btn-danger btn-icon" onclick="removeSensorRow(${index})" title="Supprimer">Ã—</button>
        </div>
      `).join('');
    }

    function addSensorRow() {
      const sensors = collectSensorsFromUI();
      sensors.push({ sensorId: '', label: '' });
      renderSensorsList(sensors);

      // Focus the new sensor ID input
      const rows = document.querySelectorAll('.sensor-row');
      const lastRow = rows[rows.length - 1];
      if (lastRow) {
        lastRow.querySelector('.sensor-id').focus();
      }
    }

    let pendingDeleteSensorIndex = null;

    function removeSensorRow(index) {
      // Store the index and show confirmation modal
      pendingDeleteSensorIndex = index;
      const sensors = collectSensorsFromUI();
      const sensor = sensors[index];
      const sensorName = sensor?.label || sensor?.sensorId || `Capteur ${index + 1}`;
      document.getElementById('confirmMessage').textContent = `Supprimer "${sensorName}" ?`;
      openModal('confirmModal');
    }

    function confirmDeleteSensor() {
      if (pendingDeleteSensorIndex !== null) {
        const sensors = collectSensorsFromUI();
        sensors.splice(pendingDeleteSensorIndex, 1);
        renderSensorsList(sensors.length > 0 ? sensors : []);
        pendingDeleteSensorIndex = null;
      }
      closeModal('confirmModal');
    }

    function collectSensorsFromUI() {
      const rows = document.querySelectorAll('.sensor-row');
      const sensors = [];

      rows.forEach(row => {
        const sensorId = row.querySelector('.sensor-id').value.trim();
        const label = row.querySelector('.sensor-label').value.trim();

        // Only include if at least sensorId is filled
        if (sensorId) {
          sensors.push({
            sensorId,
            label: label || sensorId
          });
        }
      });

      return sensors;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Form Handlers
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    document.getElementById('editRoomForm').addEventListener('submit', (e) => {
      e.preventDefault();

      localConfig.room = {
        id: document.getElementById('editRoomId').value,
        name: document.getElementById('editRoomName').value,
        site: document.getElementById('editRoomSite').value
      };

      showToast('Salle mise a jour (non sauvegarde)');
      closeModal('editRoomModal');
      markUnsavedChanges();
      renderConfig();
    });

    document.getElementById('editMqttForm').addEventListener('submit', (e) => {
      e.preventDefault();

      localConfig.mqtt = {
        ...localConfig.mqtt,
        broker: document.getElementById('editMqttBroker').value,
        baseTopic: document.getElementById('editMqttBaseTopic').value
      };

      showToast('MQTT mis a jour (non sauvegarde)');
      closeModal('editMqttModal');
      markUnsavedChanges();
      renderConfig();
    });

    document.getElementById('propForm').addEventListener('submit', (e) => {
      e.preventDefault();

      // Collect sensors from UI
      const sensors = collectSensorsFromUI();

      const mode = document.getElementById('propEditMode').value;
      const propId = document.getElementById('propId').value.trim();
      const propName = document.getElementById('propName').value.trim();
      const originalId = document.getElementById('propOriginalId').value;
      const propType = document.getElementById('propType').value;
      const pieceId = document.getElementById('propPieceId').value || null;

      // Validate prop name
      if (!propName) {
        showToast('Le nom du prop est requis', true);
        return;
      }

      // Validate prop ID
      if (!propId) {
        showToast('L\'ID du prop est requis', true);
        return;
      }

      // Validate propId format (alphanumeric, underscores, hyphens only)
      if (!/^[a-zA-Z0-9_-]+$/.test(propId)) {
        showToast('L\'ID ne peut contenir que des lettres, chiffres, tirets et underscores', true);
        return;
      }

      // Check for duplicate sensor IDs within this prop
      const sensorIds = sensors.map(s => s.sensorId);
      const duplicateSensorIds = sensorIds.filter((id, idx) => sensorIds.indexOf(id) !== idx);
      if (duplicateSensorIds.length > 0) {
        showToast(`ID de capteur en double: ${duplicateSensorIds[0]}`, true);
        return;
      }

      const propData = {
        propId,
        name: propName,
        type: propType,
        pieceId,
        order: parseInt(document.getElementById('propOrder').value, 10),
        sensors
      };

      // Update localConfig directly (no API call)
      if (mode === 'add') {
        // Check for duplicate propId
        if (localConfig.props.some(p => p.propId === propId)) {
          showToast('Un prop avec cet ID existe deja', true);
          return;
        }
        localConfig.props.push(propData);
        showToast('Prop ajoute (non sauvegarde)');
      } else {
        // Update existing prop
        const idx = localConfig.props.findIndex(p => p.propId === originalId);
        if (idx !== -1) {
          localConfig.props[idx] = propData;
          showToast('Prop mis a jour (non sauvegarde)');
        } else {
          showToast('Prop introuvable', true);
          return;
        }
      }

      closeModal('propModal');
      markUnsavedChanges();
      renderConfig();
    });

    function deleteProp(propId) {
      if (!confirm(`Supprimer le prop "${propId}" ?`)) return;

      const idx = localConfig.props.findIndex(p => p.propId === propId);
      if (idx !== -1) {
        localConfig.props.splice(idx, 1);
        showToast('Prop supprime (non sauvegarde)');
        markUnsavedChanges();
        renderConfig();
      } else {
        showToast('Prop introuvable', true);
      }
    }

    // Sensor Type Form Handler
    document.getElementById('sensorTypeForm').addEventListener('submit', (e) => {
      e.preventDefault();

      const mode = document.getElementById('sensorTypeEditMode').value;
      const id = document.getElementById('sensorTypeId').value.trim().toLowerCase();
      const originalId = document.getElementById('sensorTypeOriginalId').value;
      const label = document.getElementById('sensorTypeLabel').value.trim();

      if (!id || !label) {
        showToast('ID et label sont requis', true);
        return;
      }

      if (!localConfig.sensorTypes) {
        localConfig.sensorTypes = [];
      }

      if (mode === 'add') {
        // Check for duplicate
        if (localConfig.sensorTypes.some(t => t.id === id)) {
          showToast('Ce type existe deja', true);
          return;
        }
        localConfig.sensorTypes.push({ id, label });
        showToast('Type ajoute (non sauvegarde)');
      } else {
        const idx = localConfig.sensorTypes.findIndex(t => t.id === originalId);
        if (idx !== -1) {
          localConfig.sensorTypes[idx] = { id: originalId, label };
          showToast('Type mis a jour (non sauvegarde)');
        } else {
          showToast('Type introuvable', true);
          return;
        }
      }

      closeModal('sensorTypeModal');
      markUnsavedChanges();
      renderConfig();
    });

    function deleteSensorType(typeId) {
      const typeLabel = getTypeLabel(typeId);
      if (!confirm(`Supprimer le type "${typeLabel}" ?`)) return;

      if (!localConfig.sensorTypes) return;

      const idx = localConfig.sensorTypes.findIndex(t => t.id === typeId);
      if (idx !== -1) {
        localConfig.sensorTypes.splice(idx, 1);
        showToast('Type supprime (non sauvegarde)');
        markUnsavedChanges();
        renderConfig();
      } else {
        showToast('Type introuvable', true);
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Drag & Drop
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let draggedPropId = null;
    let draggedPropOrder = null;

    function handleDragStart(event) {
      const card = event.target.closest('.card');
      if (!card) return;

      draggedPropId = card.dataset.propId;
      draggedPropOrder = parseInt(card.dataset.propOrder, 10);

      card.classList.add('dragging');
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', draggedPropId);
    }

    function handleDragEnd(event) {
      const card = event.target.closest('.card');
      if (card) {
        card.classList.remove('dragging');
      }
      draggedPropId = null;
      draggedPropOrder = null;

      // Remove all drag-over states
      document.querySelectorAll('.drop-zone').forEach(zone => zone.classList.remove('drag-over'));
      document.querySelectorAll('.step-group').forEach(group => {
        group.classList.remove('drag-over-parallel', 'drag-over-newstep-before', 'drag-over-newstep-after');
      });
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
      event.target.classList.add('drag-over');
    }

    function handleDragLeave(event) {
      event.target.classList.remove('drag-over');
    }

    function handleStepDragOver(event) {
      event.preventDefault();
      const stepGroup = event.target.closest('.step-group');
      if (stepGroup) {
        const stepOrder = parseInt(stepGroup.dataset.step, 10);
        const rect = stepGroup.getBoundingClientRect();
        const mouseY = event.clientY;
        const topZoneEnd = rect.top + (rect.height * 0.25);
        const bottomZoneStart = rect.bottom - (rect.height * 0.25);

        // Remove all classes first
        stepGroup.classList.remove('drag-over-parallel', 'drag-over-newstep-before', 'drag-over-newstep-after');

        if (mouseY <= topZoneEnd) {
          // Top 25% - new step before
          stepGroup.classList.add('drag-over-newstep-before');
        } else if (mouseY >= bottomZoneStart) {
          // Bottom 25% - new step after
          stepGroup.classList.add('drag-over-newstep-after');
        } else if (stepOrder !== draggedPropOrder) {
          // Middle 50% - parallel (only if not same step)
          stepGroup.classList.add('drag-over-parallel');
        }
      }
      event.dataTransfer.dropEffect = 'move';
    }

    function handleStepDragLeave(event) {
      const stepGroup = event.target.closest('.step-group');
      if (stepGroup && !stepGroup.contains(event.relatedTarget)) {
        stepGroup.classList.remove('drag-over-parallel', 'drag-over-newstep-before', 'drag-over-newstep-after');
      }
    }

    // Drop between steps -> create new sequential step
    function handleDropBetween(event, afterStepOrder) {
      event.preventDefault();
      event.target.classList.remove('drag-over');

      if (!draggedPropId) return;

      // Calculate new order: insert after afterStepOrder
      // Get all unique orders sorted
      const orders = [...new Set(localConfig.props.map(p => p.order))].sort((a, b) => a - b);
      const afterIndex = orders.indexOf(afterStepOrder);

      let newOrder;
      if (afterStepOrder === 0) {
        // Dropped at the very beginning
        newOrder = orders.length > 0 ? orders[0] - 1 : 1;
        if (newOrder < 1) {
          // Need to shift all orders up
          shiftOrdersAndMove(draggedPropId, 1, true);
          return;
        }
      } else {
        // Dropped after a step
        const nextOrder = orders[afterIndex + 1];
        if (nextOrder !== undefined) {
          // There's a step after, use a value between
          newOrder = afterStepOrder + 1;
          if (newOrder >= nextOrder) {
            // Need to shift orders to make room
            shiftOrdersAndMove(draggedPropId, newOrder, true);
            return;
          }
        } else {
          // Dropped at the end
          newOrder = afterStepOrder + 1;
        }
      }

      updatePropOrder(draggedPropId, newOrder);
    }

    // Drop on step -> add as parallel (middle) OR new step (top/bottom zones)
    function handleDropOnStep(event, stepOrder) {
      event.preventDefault();
      const stepGroup = event.target.closest('.step-group');
      const isNewStepBefore = stepGroup?.classList.contains('drag-over-newstep-before');
      const isNewStepAfter = stepGroup?.classList.contains('drag-over-newstep-after');

      if (stepGroup) {
        stepGroup.classList.remove('drag-over-parallel', 'drag-over-newstep-before', 'drag-over-newstep-after');
      }

      if (!draggedPropId) return;

      if (isNewStepBefore) {
        // Top zone - create new step BEFORE this one
        const orders = [...new Set(localConfig.props.map(p => p.order))].sort((a, b) => a - b);
        const stepIndex = orders.indexOf(stepOrder);
        const prevOrder = stepIndex > 0 ? orders[stepIndex - 1] : 0;
        handleDropBetween(event, prevOrder);
      } else if (isNewStepAfter) {
        // Bottom zone - create new step AFTER this one
        handleDropBetween(event, stepOrder);
      } else if (draggedPropOrder !== stepOrder) {
        // Middle zone - add as parallel (same order), only if different step
        updatePropOrder(draggedPropId, stepOrder);
      }
    }

    function updatePropOrder(propId, newOrder) {
      const idx = localConfig.props.findIndex(p => p.propId === propId);
      if (idx !== -1) {
        localConfig.props[idx].order = newOrder;
        showToast('Ordre mis a jour (non sauvegarde)');
        markUnsavedChanges();
        renderConfig();
      }
    }

    function shiftOrdersAndMove(propId, targetOrder, insertBefore = false) {
      // Sort props by current order
      const sortedProps = [...localConfig.props].sort((a, b) => (a.order || 0) - (b.order || 0));

      // Find the prop to move
      const movingProp = localConfig.props.find(p => p.propId === propId);
      if (!movingProp) return;

      // Calculate orders and shift
      if (insertBefore) {
        // Shift all props with order >= targetOrder up by 1
        localConfig.props.forEach(p => {
          if (p.propId !== propId && p.order >= targetOrder) {
            p.order = p.order + 1;
          }
        });
      }

      // Set the new order for the moving prop
      movingProp.order = targetOrder;

      showToast('Ordre mis a jour (non sauvegarde)');
      markUnsavedChanges();
      renderConfig();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Utilities
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function getTypeLabel(typeId) {
      if (!typeId) return '';
      const sensorType = (localConfig.sensorTypes || []).find(t => t.id === typeId);
      return sensorType ? sensorType.label : typeId;
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.toggle('error', isError);
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function showRestartWarning() {
      document.getElementById('restartWarning').classList.add('show');
    }

    function hideRestartWarning() {
      document.getElementById('restartWarning').classList.remove('show');
    }

    async function reloadConfig() {
      try {
        // First save localConfig to server
        const saveRes = await fetch('/api/config', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(localConfig)
        });
        const saveData = await saveRes.json();
        if (!saveData.success) {
          showToast(saveData.error || 'Erreur lors de la sauvegarde', true);
          return;
        }

        // Then reload config in state manager
        const res = await fetch('/api/reload', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showToast('Configuration sauvegardee et rechargee (' + data.props + ' props)');
          document.getElementById('restartWarning').classList.remove('show');
          hasUnsavedChanges = false;
          fetchConfig();
          fetchState();
        } else {
          showToast(data.error || 'Erreur lors du rechargement', true);
        }
      } catch (err) {
        showToast('Erreur: ' + err.message, true);
      }
    }

    function discardChanges() {
      if (!confirm('Annuler toutes les modifications non sauvegardees ?')) return;
      localConfig = JSON.parse(JSON.stringify(config));
      hasUnsavedChanges = false;
      hideRestartWarning();
      renderConfig();
      showToast('Modifications annulees');
    }

    // Close modals on backdrop click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Export / Import
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function exportRoom() {
      const includeHistory = document.getElementById('exportHistory').checked;
      const url = `/api/export${includeHistory ? '?history=true' : ''}`;
      // Trigger browser download
      window.location.href = url;
    }

    async function importRoom() {
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];
      if (!file) {
        showToast('Selectionnez un fichier .zip', true);
        return;
      }

      if (!confirm('L\'import va remplacer la configuration et les medias actuels. Continuer ?')) return;

      const progress = document.getElementById('importProgress');
      const btn = document.getElementById('importBtn');
      progress.style.display = 'block';
      btn.disabled = true;

      try {
        const formData = new FormData();
        formData.append('archive', file);

        const res = await fetch('/api/import', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();

        if (data.success) {
          showToast(`Import termine (${data.props} props)`);
          fileInput.value = '';
          fetchConfig();
          fetchState();
        } else {
          showToast(data.error || 'Erreur lors de l\'import', true);
        }
      } catch (err) {
        showToast('Erreur: ' + err.message, true);
      } finally {
        progress.style.display = 'none';
        btn.disabled = false;
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Stats
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function fmtMs(ms) {
      if (ms == null) return '-';
      const totalSec = Math.round(ms / 1000);
      const m = Math.floor(totalSec / 60);
      const s = totalSec % 60;
      return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    async function fetchStats() {
      try {
        const [statsRes, sessionsRes] = await Promise.all([
          fetch('/api/stats'),
          fetch('/api/sessions')
        ]);
        const stats = await statsRes.json();
        const sessions = await sessionsRes.json();

        // Summary cards
        document.getElementById('statTotal').textContent = stats.summary.totalSessions;
        document.getElementById('statWinRate').textContent = stats.summary.totalSessions > 0 ? stats.summary.winRate + '%' : '-';
        document.getElementById('statAvgTime').textContent = fmtMs(stats.summary.avgDurationMs);
        document.getElementById('statAvgHints').textContent = stats.summary.avgHints;

        // Prop stats table
        const propEntries = Object.values(stats.propStats || {});
        const propCard = document.getElementById('propStatsCard');
        if (propEntries.length > 0) {
          propCard.style.display = 'block';
          const tbody = document.getElementById('propStatsBody');
          tbody.innerHTML = propEntries.map(p => `
            <tr style="border-bottom: 1px solid #2a2a2a;">
              <td style="padding: 6px 8px; color: #eee;">${p.name}</td>
              <td style="text-align: center; padding: 6px 8px; color: ${p.solveRate >= 80 ? '#22c55e' : p.solveRate >= 50 ? '#f59e0b' : '#ef4444'};">${p.solveRate}%</td>
              <td style="text-align: center; padding: 6px 8px; color: ${p.overrideRate > 20 ? '#f59e0b' : '#888'};">${p.overrideRate}%</td>
              <td style="text-align: center; padding: 6px 8px; color: #ccc;">${fmtMs(p.avgSolveTimeMs)}</td>
              <td style="text-align: center; padding: 6px 8px; color: #22c55e;">${fmtMs(p.fastestSolveTimeMs)}</td>
              <td style="text-align: center; padding: 6px 8px; color: #ef4444;">${fmtMs(p.slowestSolveTimeMs)}</td>
              <td style="text-align: center; padding: 6px 8px; color: #888;">${p.sessionsWithData}</td>
            </tr>
          `).join('');
        }

        // Session list
        if (sessions.length > 0) {
          document.getElementById('sessionListCard').style.display = 'block';
          const container = document.getElementById('sessionListAdmin');
          // Show last 50, most recent first
          const sorted = [...sessions].sort((a, b) => (b.startedAt || 0) - (a.startedAt || 0)).slice(0, 50);
          container.innerHTML = sorted.map(s => {
            const icon = s.result === 'victory' ? '&#x1F3C6;' : '&#x1F480;';
            const date = s.startedAt ? new Date(s.startedAt).toLocaleString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-';
            const duration = fmtMs(s.realDurationMs);
            const hints = s.hintsGiven || 0;
            const comments = s.comments ? `<div style="font-size: 11px; color: #888; margin-top: 4px; font-style: italic;">${s.comments}</div>` : '';
            return `<div style="padding: 8px 0; border-bottom: 1px solid #2a2a2a; font-size: 13px;">
              <span>${icon}</span>
              <span style="color: #ccc; margin-left: 6px;">${date}</span>
              <span style="color: #00d4ff; margin-left: 12px;">${duration}</span>
              <span style="color: #a78bfa; margin-left: 12px;">${hints} indice${hints !== 1 ? 's' : ''}</span>
              ${comments}
            </div>`;
          }).join('');
        }
      } catch (err) {
        console.error('Failed to fetch stats:', err);
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Scenarios
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderScenarios() {
      const container = document.getElementById('scenariosList');
      const scenarios = localConfig.scenarios || [];

      if (scenarios.length === 0) {
        container.innerHTML = '<div class="empty-state">Aucun automatisme configure</div>';
        return;
      }

      container.innerHTML = scenarios.map(sc => {
        const triggerLabel = formatTriggerLabel(sc.trigger);
        const actionsLabel = (sc.actions || []).map(a => formatActionLabel(a)).join(', ');
        const enabledBadge = sc.enabled
          ? '<span class="status-badge" style="font-size:11px;">Actif</span>'
          : '<span class="status-badge offline" style="font-size:11px;">Inactif</span>';

        return `
          <div class="card">
            <div class="card-header">
              <div>
                <span class="card-title">${sc.name}</span>
                ${enabledBadge}
              </div>
            </div>
            <div style="font-size:12px;color:#aaa;margin-bottom:4px;">
              <strong style="color:#00d4ff;">Declencheur:</strong> ${triggerLabel}
            </div>
            <div style="font-size:12px;color:#aaa;">
              <strong style="color:#fa0;">Actions:</strong> ${actionsLabel || 'Aucune'}
            </div>
            <div class="actions">
              <button class="btn-secondary btn-small" onclick="openEditScenarioModal('${sc.id}')">Modifier</button>
              <button class="btn-small" style="background:#${sc.enabled ? 'a52' : '2a5'};color:#fff;" onclick="toggleScenario('${sc.id}', ${!sc.enabled})">${sc.enabled ? 'Desactiver' : 'Activer'}</button>
              <button class="btn-danger btn-small" onclick="deleteScenario('${sc.id}')">Supprimer</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function formatTriggerLabel(trigger) {
      if (!trigger) return '?';
      switch (trigger.type) {
        case 'prop_solved': {
          const p = localConfig.props.find(p => p.propId === trigger.propId);
          return `Enigme resolue: ${p?.name || trigger.propId}`;
        }
        case 'sensor_triggered': {
          const p = localConfig.props.find(p => p.propId === trigger.propId);
          const s = p?.sensors?.find(s => s.sensorId === trigger.sensorId);
          return `Capteur: ${p?.name || trigger.propId} â†’ ${s?.label || trigger.sensorId}`;
        }
        case 'timer': {
          const totalSec = Math.round((trigger.atElapsedMs || 0) / 1000);
          const m = Math.floor(totalSec / 60);
          const s = totalSec % 60;
          return `Apres ${m}m${s > 0 ? s + 's' : ''}`;
        }
        case 'session_start': return 'Debut de session';
        case 'session_end': return 'Fin de session';
        default: return trigger.type;
      }
    }

    function formatActionLabel(action) {
      switch (action.type) {
        case 'play_audio': return `Son: ${action.file}${action.delay ? ' (+' + action.delay + 'ms)' : ''}`;
        case 'play_music': return `Musique: ${action.file}${action.delay ? ' (+' + action.delay + 'ms)' : ''}`;
        case 'stop_music': return 'Stop musique';
        case 'mqtt_cmd': return `MQTT: ${action.propId} â†’ ${action.command}`;
        default: return action.type;
      }
    }

    function populateScenarioPropDropdown(selectedPropId = '') {
      const dropdown = document.getElementById('scenarioTriggerPropId');
      dropdown.innerHTML = (localConfig.props || []).map(p =>
        `<option value="${p.propId}" ${p.propId === selectedPropId ? 'selected' : ''}>${p.name} (${p.propId})</option>`
      ).join('');
      populateScenarioSensorDropdown(selectedPropId);
    }

    function populateScenarioSensorDropdown(propId, selectedSensorId = '') {
      const dropdown = document.getElementById('scenarioTriggerSensorId');
      const prop = (localConfig.props || []).find(p => p.propId === propId);
      const sensors = prop?.sensors || [];
      dropdown.innerHTML = sensors.map(s =>
        `<option value="${s.sensorId}" ${s.sensorId === selectedSensorId ? 'selected' : ''}>${s.label} (${s.sensorId})</option>`
      ).join('');
    }

    // Update sensor dropdown when prop changes
    document.getElementById('scenarioTriggerPropId')?.addEventListener('change', function() {
      populateScenarioSensorDropdown(this.value);
    });

    function onTriggerTypeChange() {
      const type = document.getElementById('scenarioTriggerType').value;
      document.getElementById('triggerPropGroup').style.display = ['prop_solved', 'sensor_triggered'].includes(type) ? '' : 'none';
      document.getElementById('triggerSensorGroup').style.display = type === 'sensor_triggered' ? '' : 'none';
      document.getElementById('triggerTimerGroup').style.display = type === 'timer' ? '' : 'none';
    }

    let scenarioActions = [];
    let scenarioMediaFiles = []; // { name, filename, type } from /api/media/sounds

    async function fetchScenarioMedia() {
      try {
        const res = await fetch('/api/media/sounds');
        scenarioMediaFiles = await res.json();
      } catch {
        scenarioMediaFiles = [];
      }
    }

    function buildFileOptions(actionType, selectedFile) {
      const filterType = actionType === 'play_music' ? 'music' : 'effect';
      const files = scenarioMediaFiles.filter(f => f.type === filterType);
      if (files.length === 0) {
        return '<option value="">-- Aucun fichier --</option>';
      }
      return '<option value="">-- Choisir --</option>' +
        files.map(f => `<option value="${f.filename}" ${f.filename === selectedFile ? 'selected' : ''}>${f.name}</option>`).join('');
    }

    function renderScenarioActions() {
      const container = document.getElementById('scenarioActionsList');
      if (scenarioActions.length === 0) {
        container.innerHTML = '<div style="color:#666;font-size:12px;padding:8px;">Aucune action</div>';
        return;
      }
      container.innerHTML = scenarioActions.map((a, i) => `
        <div class="sensor-editor" style="margin-bottom:6px;">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <select onchange="updateScenarioAction(${i}, 'type', this.value)" style="width:150px;">
              <option value="play_audio" ${a.type === 'play_audio' ? 'selected' : ''}>Jouer un son</option>
              <option value="play_music" ${a.type === 'play_music' ? 'selected' : ''}>Jouer musique</option>
              <option value="stop_music" ${a.type === 'stop_music' ? 'selected' : ''}>Stop musique</option>
              <option value="mqtt_cmd" ${a.type === 'mqtt_cmd' ? 'selected' : ''}>Commande MQTT</option>
            </select>
            ${['play_audio', 'play_music'].includes(a.type) ? `
              <select onchange="updateScenarioAction(${i}, 'file', this.value)" style="width:200px;">
                ${buildFileOptions(a.type, a.file)}
              </select>
            ` : ''}
            ${a.type === 'mqtt_cmd' ? `
              <select onchange="updateScenarioAction(${i}, 'propId', this.value)" style="width:150px;">
                ${(localConfig.props || []).map(p => `<option value="${p.propId}" ${p.propId === a.propId ? 'selected' : ''}>${p.name}</option>`).join('')}
              </select>
              <input type="text" value="${a.command || ''}" placeholder="commande" style="width:120px;"
                     onchange="updateScenarioAction(${i}, 'command', this.value)">
            ` : ''}
            <div style="display:flex;align-items:center;gap:4px;">
              <label style="font-size:11px;color:#888;">Delai ms:</label>
              <input type="number" value="${a.delay || 0}" min="0" step="100" style="width:80px;"
                     onchange="updateScenarioAction(${i}, 'delay', parseInt(this.value))">
            </div>
            <button type="button" class="btn-danger btn-icon btn-small" onclick="removeScenarioAction(${i})">Ã—</button>
          </div>
        </div>
      `).join('');
    }

    function addScenarioAction() {
      scenarioActions.push({ type: 'play_audio', file: '', delay: 0 });
      renderScenarioActions();
    }

    function removeScenarioAction(index) {
      scenarioActions.splice(index, 1);
      renderScenarioActions();
    }

    function updateScenarioAction(index, field, value) {
      scenarioActions[index][field] = value;
      // Re-render if type changed (different fields needed)
      if (field === 'type') renderScenarioActions();
    }

    async function openAddScenarioModal() {
      await fetchScenarioMedia();
      document.getElementById('scenarioModalTitle').textContent = 'Ajouter un Automatisme';
      document.getElementById('scenarioEditMode').value = 'add';
      document.getElementById('scenarioId').value = '';
      document.getElementById('scenarioName').value = '';
      document.getElementById('scenarioEnabled').value = 'true';
      document.getElementById('scenarioTriggerType').value = 'prop_solved';
      document.getElementById('scenarioTriggerMinutes').value = '0';
      document.getElementById('scenarioTriggerSeconds').value = '0';
      populateScenarioPropDropdown();
      onTriggerTypeChange();
      scenarioActions = [];
      renderScenarioActions();
      openModal('scenarioModal');
    }

    async function openEditScenarioModal(id) {
      await fetchScenarioMedia();
      const sc = (localConfig.scenarios || []).find(s => s.id === id);
      if (!sc) return;

      document.getElementById('scenarioModalTitle').textContent = 'Modifier l\'Automatisme';
      document.getElementById('scenarioEditMode').value = 'edit';
      document.getElementById('scenarioId').value = sc.id;
      document.getElementById('scenarioName').value = sc.name;
      document.getElementById('scenarioEnabled').value = sc.enabled ? 'true' : 'false';
      document.getElementById('scenarioTriggerType').value = sc.trigger?.type || 'prop_solved';

      populateScenarioPropDropdown(sc.trigger?.propId || '');
      if (sc.trigger?.sensorId) {
        populateScenarioSensorDropdown(sc.trigger.propId, sc.trigger.sensorId);
      }

      if (sc.trigger?.type === 'timer') {
        const totalSec = Math.round((sc.trigger.atElapsedMs || 0) / 1000);
        document.getElementById('scenarioTriggerMinutes').value = Math.floor(totalSec / 60);
        document.getElementById('scenarioTriggerSeconds').value = totalSec % 60;
      }

      onTriggerTypeChange();
      scenarioActions = (sc.actions || []).map(a => ({ ...a }));
      renderScenarioActions();
      openModal('scenarioModal');
    }

    document.getElementById('scenarioForm').addEventListener('submit', (e) => {
      e.preventDefault();

      const mode = document.getElementById('scenarioEditMode').value;
      const id = document.getElementById('scenarioId').value;
      const scenarioName = document.getElementById('scenarioName').value.trim();
      const triggerType = document.getElementById('scenarioTriggerType').value;

      // Validate scenario name
      if (!scenarioName) {
        showToast('Le nom de l\'automatisme est requis', true);
        return;
      }

      // Validate at least one action
      if (scenarioActions.length === 0) {
        showToast('Au moins une action est requise', true);
        return;
      }

      // Validate action fields are filled
      for (let i = 0; i < scenarioActions.length; i++) {
        const action = scenarioActions[i];
        if (['play_audio', 'play_music'].includes(action.type) && !action.file) {
          showToast(`Action ${i + 1}: Veuillez sÃ©lectionner un fichier audio`, true);
          return;
        }
        if (action.type === 'mqtt_cmd' && (!action.propId || !action.command)) {
          showToast(`Action ${i + 1}: Prop et commande sont requis pour MQTT`, true);
          return;
        }
      }

      const trigger = { type: triggerType };
      if (['prop_solved', 'sensor_triggered'].includes(triggerType)) {
        trigger.propId = document.getElementById('scenarioTriggerPropId').value;
        // Validate propId is selected
        if (!trigger.propId) {
          showToast('Veuillez sÃ©lectionner un prop', true);
          return;
        }
      }
      if (triggerType === 'sensor_triggered') {
        trigger.sensorId = document.getElementById('scenarioTriggerSensorId').value;
        // Validate sensorId is selected
        if (!trigger.sensorId) {
          showToast('Veuillez sÃ©lectionner un capteur', true);
          return;
        }
      }
      if (triggerType === 'timer') {
        const mins = parseInt(document.getElementById('scenarioTriggerMinutes').value) || 0;
        const secs = parseInt(document.getElementById('scenarioTriggerSeconds').value) || 0;
        trigger.atElapsedMs = (mins * 60 + secs) * 1000;
        // Validate timer is not zero
        if (trigger.atElapsedMs === 0) {
          showToast('Le temps doit Ãªtre supÃ©rieur Ã  0', true);
          return;
        }
      }

      const scenarioData = {
        name: scenarioName,
        enabled: document.getElementById('scenarioEnabled').value === 'true',
        trigger,
        actions: scenarioActions
      };

      if (!localConfig.scenarios) {
        localConfig.scenarios = [];
      }

      if (mode === 'add') {
        // Generate new ID
        scenarioData.id = 'auto-' + Date.now();
        localConfig.scenarios.push(scenarioData);
        showToast('Automatisme ajoute (non sauvegarde)');
      } else {
        const idx = localConfig.scenarios.findIndex(s => s.id === id);
        if (idx !== -1) {
          localConfig.scenarios[idx] = { ...localConfig.scenarios[idx], ...scenarioData };
          showToast('Automatisme mis a jour (non sauvegarde)');
        } else {
          showToast('Automatisme introuvable', true);
          return;
        }
      }

      closeModal('scenarioModal');
      markUnsavedChanges();
      renderConfig();
    });

    function toggleScenario(id, enabled) {
      if (!localConfig.scenarios) return;

      const idx = localConfig.scenarios.findIndex(s => s.id === id);
      if (idx !== -1) {
        localConfig.scenarios[idx].enabled = enabled;
        showToast(enabled ? 'Automatisme active (non sauvegarde)' : 'Automatisme desactive (non sauvegarde)');
        markUnsavedChanges();
        renderConfig();
      }
    }

    function deleteScenario(id) {
      if (!confirm('Supprimer cet automatisme ?')) return;

      if (!localConfig.scenarios) return;

      const idx = localConfig.scenarios.findIndex(s => s.id === id);
      if (idx !== -1) {
        localConfig.scenarios.splice(idx, 1);
        showToast('Automatisme supprime (non sauvegarde)');
        markUnsavedChanges();
        renderConfig();
      } else {
        showToast('Automatisme introuvable', true);
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Init
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Tabs
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    document.querySelectorAll('.tab-bar .tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-bar .tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');

        // Lazy-load data for specific tabs
        if (btn.dataset.tab === 'audio') fetchMediaList();
        if (btn.dataset.tab === 'stats') fetchStats();
      });
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Audio / Media
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let mediaItems = [];
    let currentPreviewAudio = null;

    async function fetchMediaList() {
      try {
        const res = await fetch('/api/media/sounds');
        mediaItems = await res.json();
        renderMediaLists();
      } catch (err) {
        console.error('Failed to fetch media:', err);
      }
    }

    function renderMediaLists() {
      const effects = mediaItems.filter(s => !s.type || s.type === 'effect');
      const music = mediaItems.filter(s => s.type === 'music');

      renderMediaTable('effectsList', 'effectsEmpty', effects);
      renderMediaTable('musicList', 'musicEmpty', music);
    }

    function renderMediaTable(tbodyId, emptyId, items) {
      const tbody = document.getElementById(tbodyId);
      const empty = document.getElementById(emptyId);

      if (items.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = '';
        return;
      }

      empty.style.display = 'none';
      const isMusic = tbodyId === 'musicList';
      const subfolder = isMusic ? 'music' : 'effects';

      tbody.innerHTML = items.map(s => {
        const audioUrl = `/media/${subfolder}/${s.filename}`;
        const roleLabels = { victory: 'Victoire', defeat: 'DÃ©faite' };
        const roleBadge = !isMusic && s.role ? `<span class="role-badge">${roleLabels[s.role] || s.role}</span>` : '';
        const roleColumn = isMusic ? '' : `
            <td>
              <select onchange="setMediaRole('${s.key}', this.value)" style="font-size:12px;padding:4px;background:#1a1a2e;color:#ccc;border:1px solid #444;border-radius:4px;">
                <option value="" ${!s.role ? 'selected' : ''}>Aucun</option>
                <option value="victory" ${s.role === 'victory' ? 'selected' : ''}>Victoire</option>
                <option value="defeat" ${s.role === 'defeat' ? 'selected' : ''}>Defaite</option>
              </select>
            </td>`;
        return `
          <tr>
            <td style="white-space:nowrap;">
              <button class="media-preview-btn" onclick="togglePreview('${audioUrl}', this)" title="Ecouter">&#9654;</button>
              <span class="media-duration" data-url="${audioUrl}" style="color:#888;font-size:12px;margin-left:6px;">--:--</span>
            </td>
            <td>${s.name}${roleBadge}</td>${roleColumn}
            <td>
              <button class="btn-secondary btn-small" onclick="promptRenameMedia('${s.key}', '${s.name.replace(/'/g, "\\'")}')">Renommer</button>
              <button class="btn-danger btn-small" onclick="confirmDeleteMedia('${s.key}', '${s.name.replace(/'/g, "\\'")}')">Supprimer</button>
            </td>
          </tr>
        `;
      }).join('');

      // Load durations for all tracks
      loadMediaDurations();
    }

    function loadMediaDurations() {
      document.querySelectorAll('.media-duration').forEach(span => {
        const url = span.dataset.url;
        if (!url) return;
        const audio = new Audio();
        audio.preload = 'metadata';
        audio.onloadedmetadata = () => {
          span.textContent = formatDuration(audio.duration);
        };
        audio.onerror = () => {
          span.textContent = '--:--';
        };
        audio.src = url;
      });
    }

    function formatDuration(seconds) {
      if (!isFinite(seconds)) return '--:--';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function togglePreview(url, btn) {
      const audio = document.getElementById('mediaPreviewAudio');

      if (currentPreviewAudio === url && !audio.paused) {
        audio.pause();
        audio.currentTime = 0;
        currentPreviewAudio = null;
        btn.innerHTML = '&#9654;';
        return;
      }

      // Reset all play buttons
      document.querySelectorAll('.media-preview-btn').forEach(b => b.innerHTML = '&#9654;');

      audio.src = url;
      audio.play();
      currentPreviewAudio = url;
      btn.innerHTML = '&#9632;';

      audio.onended = () => {
        btn.innerHTML = '&#9654;';
        currentPreviewAudio = null;
      };
    }

    async function uploadMedia() {
      const fileInput = document.getElementById('mediaFile');
      const nameInput = document.getElementById('mediaName');
      const typeSelect = document.getElementById('mediaType');

      const file = fileInput.files[0];
      if (!file) {
        showToast('Selectionnez un fichier audio', true);
        return;
      }

      const name = nameInput.value.trim() || file.name.replace(/\.[^.]+$/, '');

      const form = new FormData();
      form.append('name', name);
      form.append('type', typeSelect.value);
      form.append('file', file);

      try {
        const res = await fetch('/api/media/sounds', { method: 'POST', body: form });
        if (!res.ok) throw new Error('Upload failed');
        showToast('Audio importe');
        fileInput.value = '';
        nameInput.value = '';
        fetchMediaList();
      } catch (err) {
        showToast('Erreur: ' + err.message, true);
      }
    }

    function promptRenameMedia(key, currentName) {
      const newName = prompt('Nouveau nom:', currentName);
      if (newName && newName !== currentName) {
        renameMedia(key, newName);
      }
    }

    async function renameMedia(key, newName) {
      try {
        const res = await fetch(`/api/media/sounds/${key}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: newName })
        });
        const data = await res.json();
        if (data.error === 'Name already taken') {
          showToast('Ce nom est deja utilise', true);
          return;
        }
        if (!res.ok) throw new Error(data.error || 'Rename failed');
        showToast('Audio renomme');
        fetchMediaList();
      } catch (err) {
        showToast('Erreur: ' + err.message, true);
      }
    }

    function confirmDeleteMedia(key, name) {
      if (!confirm(`Supprimer "${name}" ?`)) return;
      deleteMedia(key);
    }

    async function deleteMedia(key) {
      try {
        const res = await fetch(`/api/media/sounds/${key}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Delete failed');
        showToast('Audio supprime');
        fetchMediaList();
      } catch (err) {
        showToast('Erreur: ' + err.message, true);
      }
    }

    async function setMediaRole(key, role) {
      try {
        const res = await fetch(`/api/media/sounds/${key}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role: role || null })
        });
        if (!res.ok) throw new Error('Failed to set role');
        showToast('Role mis a jour');
        fetchMediaList();
      } catch (err) {
        showToast('Erreur: ' + err.message, true);
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Init
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    fetchConfig();
    fetchState();
    setInterval(fetchState, 5000); // Poll state every 5s
  </script>
</body>
</html>
